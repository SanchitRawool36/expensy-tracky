<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Finance Ledger</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #111827; padding-top: 72px; line-height: 1.5; }
    .card { background-color: #1F2937; border: 1px solid #374151; border-radius: 0.75rem; box-shadow: 0 8px 24px rgba(0,0,0,0.25); }
    .btn { color: white; font-weight: 500; padding: 0.5rem 1rem; border-radius: 0.5rem; transition: background-color 0.2s; border: 1px solid transparent; cursor: pointer; outline: none; }
    .btn:disabled { background-color: #4b5563; cursor: not-allowed; }
    .btn-primary { background-color: #4F46E5; } .btn-primary:hover:not(:disabled) { background-color: #4338CA; }
    .btn-secondary { background-color: #374151; border-color: #4b5563; } .btn-secondary:hover:not(:disabled) { background-color: #4b5563; }
    .btn-success { background-color: #16a34a; } .btn-success:hover { background-color: #15803d; }
    .btn:focus-visible { box-shadow: 0 0 0 3px rgba(99,102,241,0.5); }
    .btn-icon { padding: .25rem; width: 2rem; height: 2rem; border-radius: 9999px; display: grid; place-items: center; }
    .table-header { background-color: #374151; }
    .table-row { border-bottom: 1px solid #374151; }
    .table-row:last-child { border-bottom: none; }
    .input-field { background-color: #374151; border: 1px solid #4b5563; border-radius: 0.5rem; padding: 0.5rem 1rem; color: white; width: 100%; outline: none; }
    .input-field:disabled { background-color: #4b5563; cursor: not-allowed; }
    .input-field::placeholder { color: #9CA3AF; }
    .input-field:focus-visible { border-color: #6366F1; box-shadow: 0 0 0 3px rgba(99,102,241,0.35); }
    .summary-value { white-space: nowrap; overflow: visible; text-overflow: clip; display: inline-block; padding-right: 0.5rem; }
    thead th.p-3, tbody td.p-3, tfoot td.p-2 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    @media (max-width: 640px) { thead th.p-3, tbody td.p-3 { padding-left: 0.5rem; padding-right: 0.5rem; } }
    .summary-cards { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: stretch; }
    .summary-card { min-width: 120px; flex: 1 1 120px; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .cal-day { background:#111827; border:1px solid #374151; padding:8px; min-height:60px; color:#d1d5db; border-radius:6px; }
    .cal-day .date { font-size:12px; color:#9ca3af; }
    .cal-day .events { margin-top:6px; font-size:12px; }
    .right-column { max-height: calc(100vh - 160px); overflow: auto; padding-right: 6px; }
    @media (max-width: 1024px) { .right-column { max-height: none; overflow: visible; padding-right: 0; } .cal-day { min-height: 48px; padding:6px; } }
    #due-banner { position: fixed; bottom: 16px; right: 16px; max-width: 22rem; z-index: 1000; }
    @media (max-width: 640px) { #due-banner { left: 12px; right: 12px; bottom: 12px; max-width: none; } }
    @media (max-width: 640px) { .summary-value { font-size: 0.95rem; } .text-2xl.summary-value { font-size: 1.25rem; } }
    #toast-stack { position: fixed; top: 76px; right: 16px; z-index: 1100; display: flex; flex-direction: column; gap: 8px; }
    .toast { min-width: 260px; max-width: 360px; color: #e5e7eb; background: #111827; border: 1px solid #374151; border-left-width: 4px; border-radius: 10px; padding: 10px 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.45); animation: toast-in 180ms ease-out; }
    .toast.info { border-left-color: #3b82f6; } .toast.success { border-left-color: #10b981; } .toast.warning { border-left-color: #f59e0b; } .toast.error { border-left-color: #ef4444; }
    .toast .title { font-weight: 600; margin-bottom: 2px; } .toast .msg { font-size: 0.9rem; }
    @keyframes toast-in { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
    .input-invalid { border-color: #ef4444 !important; box-shadow: 0 0 0 1px #ef4444 inset; }
  </style>
</head>
<body class="text-gray-200">
  <nav class="sticky top-0 z-50 bg-gradient-to-r from-indigo-600 to-purple-700 shadow-lg border-b border-indigo-400/30">
    <div class="mx-auto max-w-7xl px-4 md:px-6 lg:px-8 py-3">
      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="text-xl md:text-2xl font-bold text-white">Finance Ledger</div>
          <div class="text-xs md:text-sm text-indigo-100/90">Track spending, save your history, and manage recurring payments.</div>
        </div>
      </div>
    </div>
  </nav>

  <div class="container mx-auto max-w-7xl p-4 md:p-6 lg:p-8">
    <div id="toast-stack" aria-live="polite" aria-atomic="true"></div>
    <header class="mb-6 flex flex-col sm:flex-row justify-between items-center">
      <div class="flex flex-col sm:flex-row sm:items-center gap-4 w-full justify-between">
        <div id="history-selector-container" class="text-center sm:text-left flex items-center gap-2">
          <button id="prev-month-btn" class="btn btn-secondary btn-icon" aria-label="Previous month" title="Previous month">‚óÄ</button>
          <select id="month-selector" class="input-field" title="Select month"></select>
          <button id="next-month-btn" class="btn btn-secondary btn-icon" aria-label="Next month" title="Next month">‚ñ∂</button>
        </div>
      </div>
      <div id="due-banner" class="w-full mt-3 hidden"></div>
      <div class="flex gap-2 items-center">
        <button id="save-month-btn" class="btn btn-success mt-4 sm:mt-0">End & Save Month</button>
        <select id="overall-range-select" class="input-field mt-4 sm:mt-0 w-auto" title="Select overall range">
          <option value="3m">Last 3 months</option>
          <option value="6m">Last 6 months</option>
          <option value="1y" selected>Last 1 year</option>
          <option value="5y">Last 5 years</option>
        </select>
        <button id="export-overall-expenses-btn" class="btn btn-secondary mt-4 sm:mt-0">Download Overall Expenses</button>
        <button id="reset-data-btn" class="btn btn-secondary mt-4 sm:mt-0">Reset All Data</button>
      </div>
    </header>

    <div id="view-mode-banner" class="card p-3 mb-4 hidden">
      <div class="flex items-center justify-between gap-3">
        <div class="text-sm text-blue-200">Viewing history month: <span id="view-mode-label" class="font-semibold text-white"></span> ‚Äî editing is disabled.</div>
        <button id="back-to-current-btn" class="btn btn-secondary btn-icon" aria-label="Back to current month" title="Back to current month">‚§¥</button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 flex flex-col gap-6">
        <div class="card p-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
            <div>
              <label for="monthly-income" class="block text-sm font-medium text-gray-300 mb-1">Add Income (‚Çπ)</label>
              <div class="flex gap-2">
                <input type="number" id="monthly-income" name="monthly-income" placeholder="e.g., 50000" class="input-field">
                <button id="add-income-btn" class="btn btn-primary">Add</button>
              </div>
              <p class="text-xs text-gray-400 mt-2">Add salary or other income. It will credit the selected bank account.</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-1">Select Bank Account</label>
              <div class="flex gap-2 items-center">
                <button id="add-account-open" class="btn btn-secondary">Add</button>
              </div>
              <p id="account-balance" class="text-sm text-gray-400 mt-2">Balance: ‚Çπ0.00</p>
              <div id="account-list" class="mt-2 flex gap-2 flex-nowrap md:flex-wrap overflow-x-auto"></div>
            </div>
            <div class="summary-cards mt-4 md:mt-0">
              <div class="text-center p-3 bg-gray-900 rounded-lg summary-card">
                <div class="flex items-center justify-center gap-2">
                  <span class="text-sm font-medium text-gray-400">Income (month)</span>
                  <button id="toggle-income-visibility" class="btn btn-secondary px-2 py-1 text-xs" aria-pressed="false" aria-label="Hide income">üëÅÔ∏è</button>
                </div>
                <p id="summary-income" class="text-lg font-bold text-green-400 summary-value" aria-live="polite">‚Çπ0.00</p>
              </div>
              <div class="text-center p-3 bg-gray-900 rounded-lg summary-card">
                <div class="flex items-center justify-center gap-2">
                  <span class="text-sm font-medium text-gray-400">Spent</span>
                  <button id="toggle-spent-visibility" class="btn btn-secondary px-2 py-1 text-xs" aria-pressed="false" aria-label="Hide spent">üëÅÔ∏è</button>
                </div>
                <p id="summary-spent" class="text-lg font-bold text-red-400 summary-value" aria-live="polite">‚Çπ0.00</p>
              </div>
              <div class="text-center p-3 bg-gray-900 rounded-lg summary-card">
                <div class="flex items-center justify-center gap-2">
                  <span id="summary-total-label" class="text-sm font-medium text-gray-400">Total</span>
                  <button id="toggle-total-visibility" class="btn btn-secondary px-2 py-1 text-xs" aria-pressed="false" aria-label="Hide total">üëÅÔ∏è</button>
                </div>
                <p id="summary-remaining" class="text-2xl font-bold text-blue-400 summary-value" aria-live="polite">‚Çπ0.00</p>
              </div>
            </div>
          </div>
        </div>

        <div class="card p-6">
          <div class="flex items-center justify-between mb-4 gap-3">
            <h2 class="text-xl font-bold text-white">Expense Ledger</h2>
            <button id="download-expense-ledger-btn" class="btn btn-secondary">Download Expense Ledger (CSV)</button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
              <thead class="table-header">
                <tr>
                  <th class="p-3">Date</th>
                  <th class="p-3">Description</th>
                  <th class="p-3">Category</th>
                  <th class="p-3">Account</th>
                  <th class="p-3 text-right">Amount (‚Çπ)</th>
                </tr>
              </thead>
              <tbody id="expense-table-body"></tbody>
              <tfoot id="expense-form-footer">
                <tr id="add-expense-row">
                  <td class="p-2"><input type="text" id="expense-desc" name="expense-desc" placeholder="Add Description" class="input-field" aria-label="Expense description"></td>
                  <td class="p-2">
                    <select id="expense-cat" class="input-field">
                      <option>Groceries</option><option>Dining Out</option><option>Rent</option><option>Utilities</option><option>Transportation</option><option>Shopping</option><option>Entertainment</option><option>Health</option><option>Education</option><option>Miscellaneous</option>
                    </select>
                  </td>
                  <td class="p-2 align-middle"><div id="input-account-label" class="text-sm text-gray-400">‚Äî</div></td>
                  <td class="p-2"><input type="number" id="expense-amount" name="expense-amount" placeholder="Amount" class="input-field text-right" aria-label="Expense amount"></td>
                </tr>
                <tr>
                  <td colspan="4" class="pt-3"><button id="add-expense-btn" class="btn btn-primary w-full">Add Expense</button></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <div class="lg:col-span-1 flex flex-col gap-6 right-column">
        <div id="account-add-card" class="card p-6 hidden">
          <h3 class="font-bold text-white mb-3">Add Bank Account</h3>
          <input id="new-account-name" name="new-account-name" class="input-field mb-2" placeholder="Account name (e.g., SBI Savings)" aria-label="New account name">
          <input id="new-account-balance" name="new-account-balance" type="number" class="input-field mb-2" placeholder="Initial balance (‚Çπ)" aria-label="New account initial balance">
          <div class="flex gap-2">
            <button id="save-account-btn" class="btn btn-primary">Save</button>
            <button id="cancel-account-btn" class="btn btn-secondary">Cancel</button>
          </div>
        </div>

        <div id="allocation-card" class="card p-6">
          <h2 class="text-xl font-bold text-white mb-4">Allocate Remaining Funds</h2>
          <div class="space-y-4">
            <div>
              <label for="allocate-invest" class="block text-sm font-medium text-gray-300 mb-1">Invest / Goal</label>
              <div class="flex gap-2">
                <input type="number" id="allocate-invest" name="allocate-invest" placeholder="Amount" class="input-field" aria-label="Allocate to invest amount">
                <button class="btn btn-secondary allocate-btn" data-desc="Investment" data-cat="Investment">Allocate</button>
              </div>
            </div>
            <div>
              <label for="allocate-home" class="block text-sm font-medium text-gray-300 mb-1">Send Home</label>
              <div class="flex gap-2">
                <input type="number" id="allocate-home" name="allocate-home" placeholder="Amount" class="input-field" aria-label="Allocate to family amount">
                <button class="btn btn-secondary allocate-btn" data-desc="Sent to Family" data-cat="Family">Allocate</button>
              </div>
            </div>
          </div>
        </div>

        <div id="settings-card" class="card p-6">
          <h2 class="text-xl font-bold text-white mb-4">Settings</h2>
          <label class="flex items-center gap-2 text-sm text-gray-300">
            <input id="toggle-due-toast" type="checkbox" class="accent-indigo-600"> Hide due banner/toast
          </label>
          <div class="mt-4 flex flex-wrap gap-2">
            <button id="backup-btn" class="btn btn-secondary">Download Backup (JSON)</button>
            <button id="restore-btn" class="btn btn-secondary">Restore Backup</button>
            <input id="restore-file" type="file" accept="application/json" class="hidden" />
          </div>
        </div>

        <div class="card p-6">
          <h2 class="text-xl font-bold text-white mb-4">Your Goals</h2>
          <div id="goals-container" class="space-y-4"></div>
          <div class="mt-4 pt-4 border-t border-gray-700">
            <h3 class="text-sm font-medium text-gray-300 mb-2">Create New Goal</h3>
            <input id="new-goal-name" name="new-goal-name" class="input-field mb-2" placeholder="Goal name (e.g., Vacation)" aria-label="New goal name">
            <input id="new-goal-target" name="new-goal-target" type="number" class="input-field mb-2" placeholder="Target amount (‚Çπ)" aria-label="New goal target amount">
            <div class="flex gap-2">
              <select id="new-goal-account" class="input-field"></select>
              <button id="create-goal-btn" class="btn btn-primary">Create</button>
            </div>
          </div>
        </div>

        <div id="recurring-card" class="card p-6">
          <h2 class="text-xl font-bold text-white mb-4">Common / Recurring Expenses</h2>
          <div id="recurring-list" class="space-y-3 mb-4"></div>
          <div class="pt-3 border-t border-gray-700">
            <h3 class="text-sm font-medium text-gray-300 mb-2">Create Recurring Expense</h3>
            <input id="rec-name" name="rec-name" class="input-field mb-2" placeholder="Name (e.g., Rent)" aria-label="Recurring expense name">
            <input id="rec-amount" name="rec-amount" type="number" class="input-field mb-2" placeholder="Amount (‚Çπ) ‚Äî for fixed; optional for variable" aria-label="Recurring amount">
            <select id="rec-type" class="input-field mb-2"><option value="fixed">Fixed (auto)</option><option value="variable">Variable (default estimate)</option></select>
            <div class="flex gap-2 mb-2">
              <input id="rec-occ" name="rec-occ" type="number" class="input-field" placeholder="Occurrences (months) e.g., 60" aria-label="Recurring occurrences">
              <select id="rec-interval" class="input-field"><option value="1">Monthly</option><option value="3">Quarterly</option><option value="12">Yearly</option></select>
            </div>
            <input id="rec-default-est" name="rec-default-est" type="number" class="input-field mb-2" placeholder="Default estimate for variable (‚Çπ)" aria-label="Recurring default estimate">
            <select id="rec-account" name="rec-account" class="input-field mb-2" aria-label="Recurring linked account"></select>
            <div class="flex gap-2">
              <label class="text-sm text-gray-300 flex items-center"><input type="checkbox" id="rec-auto" name="rec-auto" class="mr-2">Auto-pay when income arrives</label>
              <button id="create-rec-btn" class="btn btn-primary">Create</button>
            </div>
          </div>
        </div>

        <div id="due-dashboard-card" class="card p-6">
          <h2 class="text-xl font-bold text-white mb-4">Monthly Due Dashboard</h2>
          <div id="due-details" class="text-sm text-gray-300"></div>
          <div id="calendar-container" class="mt-3"></div>
        </div>

        <div id="spending-chart-card" class="card p-6">
          <h2 class="text-xl font-bold text-white mb-4">Spending Breakdown</h2>
          <div class="h-64"><canvas id="expense-chart" aria-label="Spending Breakdown Chart"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
</body>
</html>
